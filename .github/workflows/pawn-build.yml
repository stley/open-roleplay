# .github/workflows/pawn-build.yml
name: Pawn Build
on:
  pull_request:
    branches: ["**"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq unzip

      - name: Download pawncc v3.10.11 (Linux x64)
        shell: bash
        run: |
          set -euo pipefail
          TAG="v3.10.11"
          API="https://api.github.com/repos/openmultiplayer/compiler/releases/tags/${TAG}"
          url="$(curl -fsSL "$API" \
            | jq -r '.assets[]
              | select((.name|test("linux";"i")) and (.name|test("x64|x86_64";"i")) and (.name|test("\\.(zip|tar\\.gz)$";"i")))
              | .browser_download_url' | head -n1)"
          [ -n "$url" ] || { echo "::error::No matching Linux x64 asset found for ${TAG}"; exit 1; }
          echo "Asset: $url"
          curl -fsSL "$url" -o pawncc.asset
          mkdir -p pawnc-bin
          if file pawncc.asset | grep -qi 'Zip archive'; then
            unzip -q pawncc.asset -d pawnc-bin
          else
            tar -xzf pawncc.asset -C pawnc-bin
          fi
          chmod +x pawnc-bin/pawncc || true
          echo "pawncc present:" && ls -l pawnc-bin

      - name: Validate layout
        shell: bash
        run: |
          test -f gamemodes/main.pwn || { echo "::error::missing gamemodes/main.pwn"; exit 1; }
          test -d qawno/include      || { echo "::error::missing qawno/include"; exit 1; }
          test -d gamemodes/modules  || { echo "::error::missing gamemodes/modules"; exit 1; }

      - name: Compile main.pwn (warnings fail, no artifact)
        shell: bash
        run: |
          set -o pipefail
          TARGET="gamemodes/main.pwn"
          INCLUDES=(-i qawno/include -i gamemodes -i gamemodes/modules)
          while IFS= read -r -d '' d; do INCLUDES+=(-i "$d"); done < <(find gamemodes/modules -type d -print0)

          echo "Include paths:" "${INCLUDES[@]}"
          pawnc-bin/pawncc "$TARGET" "${INCLUDES[@]}" -d3 -Z+ -E -o /dev/null 2>&1 | tee build.log
          ec=${PIPESTATUS[0]}
          warns=$(grep -Eic 'warning[[:space:]]+[0-9]+:' build.log || true)
          errs=$(grep -Eic 'error[[:space:]]+[0-9]+:' build.log || true)
          echo "pawncc exit: $ec  warnings: $warns  errors: $errs"
          if [ $ec -ne 0 ]; then echo "::error::pawncc exit $ec"; tail -n 200 build.log || true; exit $ec; fi
          if [ "$warns" -gt 0 ]; then echo "::error::Pawn warnings detected ($warns). Failing build."; grep -Ein 'warning[[:space:]]+[0-9]+:' build.log | tail -n 100 || true; exit 1; fi
          echo "OK: no warnings"